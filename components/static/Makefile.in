#
# BEGIN SONGBIRD GPL
#
# This file is part of the Songbird web player.
#
# Copyright(c) 2005-2008 POTI, Inc.
# http://www.songbirdnest.com
#
# This file may be licensed under the terms of of the
# GNU General Public License Version 2 (the “GPL”).
#
# Software distributed under the License is distributed
# on an “AS IS” basis, WITHOUT WARRANTY OF ANY KIND, either
# express or implied. See the GPL for the specific language
# governing rights and limitations.
#
# You should have received a copy of the GPL along with this
# program. If not, go to http://www.gnu.org/licenses/gpl.html
# or write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
#
# END SONGBIRD GPL
#

DEPTH = ../..
topsrcdir = @top_srcdir@
srcdir = @srcdir@
VPATH = @srcdir@

include $(DEPTH)/build/autodefs.mk

target := sbComponents

CPP_SRCS = \
  nsStaticComponents.cpp \
  sbStaticModule.cpp \
  $(NULL)

CPP_INCLUDES = \
  $(MOZSDK_INCLUDE_DIR) \
  $(MOZSDK_INCLUDE_DIR)/nspr \
  $(MOZSDK_INCLUDE_DIR)/necko \
  $(MOZSDK_INCLUDE_DIR)/string \
  $(MOZSDK_INCLUDE_DIR)/xpcom \
  $(NULL)

DYNAMIC_LIB = $(target)$(DEBUG:%:_d)$(DLL_SUFFIX)

DYNAMIC_LIB_OBJS = $(CPP_SRCS:.cpp=$(OBJ_SUFFIX)) \
    $(shell cat link-libs)

DYNAMIC_LIB_EXTRA_IMPORTS = \
  xpcomglue_s \
  $(shell cat link-imports) \
  $(NULL)

DYNAMIC_LIB_STATIC_IMPORTS = \
  $(shell cat link-static-imports)

DYNAMIC_LIB_IMPORT_PATHS = $(MOZSDK_LIB_DIR) \
  $(shell cat link-paths)

SONGBIRD_COMPONENTS = \
  $(DYNAMIC_LIB) \
  $(NULL)

STATIC_COMPONENT_LIST = $(shell cat link-names)

LDFLAGS += $(shell cat link-flags)

SHELL_EXECUTE = -c echo Running xpt_link...

include $(topsrcdir)/build/rules.mk

shell_execute: $(SONGBIRD_COMPONENTSDIR)/songbird.xpt

$(SONGBIRD_COMPONENTSDIR)/songbird.xpt: $(wildcard *.xpt)
	$(CYGWIN_WRAPPER) $(XPTLINK) $@ $^
	$(CHMOD) -x $@

clean::
	$(RM) -f link-names link-libs link-paths link-imports link-static-imports \
	         link-flags nsStaticComponents.cpp

nsStaticComponents.cpp: nsStaticComponents.cpp.in link-names Makefile Makefile.in
	rm -rf $@
	cat $< | \
            sed -e "s|%MODULE_LIST%|$(foreach m, $(STATIC_COMPONENT_LIST),MODULE($(m)))|" \
            > $@

